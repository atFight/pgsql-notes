#  WAL 

在 PostgreSQL 中，WAL 是 Write-Ahead Logging（预写式日志记录）的缩写，是一种数据库管理系统用于保证事务持久性和恢复能力的关键技术。 

## 工作原理

1. **事务日志记录：** 当一个事务对数据库进行修改时（例如插入、更新、删除操作），不会立即将这些修改写入数据库文件中。相反，它首先将这些修改操作记录到 WAL 日志文件中。这些记录包括了修改前和修改后的数据。
2. **持久性：** 写入WAL文件后，认为事务已经提交。这意味着即使在修改写入磁盘之前，系统崩溃或断电，也可以通过重新应用 WAL 日志来恢复事务的状态。
3. **恢复：** 在系统崩溃或重启时，PostgreSQL 可以使用 WAL 日志来恢复事务。通过重新应用 WAL 日志中的操作，可以将数据库恢复到崩溃之前的一致状态。



## 使用场景

**事务提交（Transaction Commit）**： 在每次事务提交时，所有修改会先写入 WAL，然后才会实际写入数据文件。这是 WAL 的核心用途，确保在系统崩溃时可以重放日志来恢复数据。

**崩溃恢复（Crash Recovery）**： 当 PostgreSQL 意外崩溃时（如断电或进程崩溃），在重新启动时，WAL 会被读取并应用，重放未持久化的事务操作，从而恢复数据库到一致状态。

**检查点（Checkpoint）**： PostgreSQL 定期生成检查点，将内存中的修改同步到磁盘上的数据文件。WAL 在此时确保即使检查点生成过程中发生崩溃，数据依然可以通过重放 WAL 日志恢复。

**归档日志（WAL Archiving）**： 在启用归档模式时，WAL 日志会定期被归档，以便之后用于数据库的时间点恢复（PITR），或者备份恢复场景中用来重放历史修改。

**流复制（Streaming Replication）**： 在主备复制架构中，WAL 是用于从主数据库向备库传递数据更改的核心机制。主库生成的 WAL 日志通过网络传递给备库，备库重放这些日志保持与主库数据同步。

**逻辑复制（Logical Replication）**： 除了物理层面的流复制，WAL 还可用于逻辑复制，传递更细粒度的数据变化（如表级别的数据变动），用于特定的数据同步或跨不同系统的数据集成。

**增量备份**： 使用增量备份时，备份工具会依赖 WAL 来记录自上次备份以来的所有变更，从而在恢复时可以基于备份恢复数据，并重放 WAL 日志来恢复到最新状态。



## 优点

- **提高性能：** 因为事务不必等待数据写入磁盘，所以可以获得更好的性能。
- **持久性：** 通过记录修改操作到 WAL 日志，可以确保事务的持久性，即使发生系统故障。
- **恢复能力：** WAL 日志允许 PostgreSQL 在系统崩溃后进行恢复，以确保数据库一致性。

总之，WAL 是 PostgreSQL 中用于事务管理和持久性的关键机制，它在数据库系统的可靠性和恢复性方面发挥了重要作用。



## 事务提交的过程

1. **写入 WAL**：当事务提交时，其变更首先写入到 WAL 日志。
2. **事务结束**：一旦 WAL 记录被成功写入，事务就被认为是成功提交的。（此时，对于数据库来说，这些变更是永久性的。）
3. **修改缓冲区**：同时，更改会应用到数据库的缓冲区中，这通常是在内存里的数据页。
4. **数据文件更新**：WAL 记录中的变更最终会被刷新到数据文件中（先Step3刷到内存的数据页中），通常是在后台**异步进行**的。PostgreSQL通过**检查点（checkpoint）**和**后台写入进程**来管理这个过程。
5. **检查点的比较**：这时，pageHeader中的**`pd_lsn`** 会被用来确定哪些数据页自上次检查点以来被修改过，确保所有必要的数据页都被写入到磁盘。



## Q&A

**为什么WAL能够提升性能**

> WAL 机制涉及将更改记录到日志文件中，而这些日志文件是以**顺序写入**的方式进行的。顺序写入相比随机写入（如直接**更新数据库文件中的多个位置**）在磁盘操作上更快，因为它减少了磁头移动的次数和范围，这使得写入操作更加高效。



**更改数据写入磁盘前，其他查询对该更改是否可见**

> **查询可见性**：提交的变更在事务成功提交后**对新的查询是可见的**。这意味着，即使这些变更还没有被刷新到数据文件，其他事务也能看到这些变更的结果。这是由 PostgreSQL 的多版本并发控制（**MVCC**）机制保证的。



**为什么WAL 能提高性能并支持高并发**

> 解耦了事务的提交和数据文件的物理写入操作



**Postgresql哪些情况会触发数据库的checkpoint**

1. 手动执行CHECKPOINT命令
2. 执行需要检查点的命令（例如pg_start_backup 或pg_ctl stop|restart等等）
3. 达到检查点配置时间(checkpoint_timeout)
4. max_wal_size已满
5. 数据库正常shutdown